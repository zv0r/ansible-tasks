# Protocols
protocols = imap lmtp sieve

# Plugins
mail_plugins = 

# TLS configuration
# 
# generated 2022-01-11, Mozilla Guideline v5.6, Dovecot 2.3.9, OpenSSL 1.1.1d, intermediate configuration
# https://ssl-config.mozilla.org/#server=dovecot&version=2.3.9&config=intermediate&openssl=1.1.1d&guideline=5.6
ssl = required
ssl_dh = <{{ dh_params }}
ssl_cert = <{{ mail_domains[0].cert_fullchain_file }}
ssl_key = <{{ mail_domains[0].cert_key_file }}
{% for mail_domain in mail_domains %}

local_name {{ mail_domain.server_fqdn }} {
    ssl_cert = <{{ mail_domain.cert_fullchain_file }}
    ssl_key = <{{ mail_domain.cert_key_file }}
}
{% endfor %}

ssl_min_protocol = TLSv1.2
ssl_cipher_list = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
ssl_prefer_server_ciphers = no

# Dovecot services
service imap-login {
    inet_listener imap {
        port = 143
    }
    inet_listener imaps {
        port = 993
    }
}

service managesieve-login {
    inet_listener sieve {
        port = 4190
    }
}

service lmtp {
    unix_listener /var/spool/postfix/private/dovecot-lmtp {
        mode = 0660
        group = postfix
        user = postfix
    }

    user = {{ mail_storage_user }}
}

service auth {
    ## Auth socket for Postfix
    unix_listener /var/spool/postfix/private/auth {
        mode = 0660
        user = postfix
        group = postfix
    }

    ## Auth socket for LMTP service
    unix_listener auth-userdb {
        mode = 0660
        user = {{ mail_storage_user }}
        group = {{ mail_storage_group }}
    }
}

service stats {
    fifo_listener stats-mail {
        user = {{ mail_storage_user }}
        mode = 0644
    }

    inet_listener {
        address = 127.0.0.1
        port = 24242
    }
}

# Protocol settings
protocol imap {
    mail_plugins = $mail_plugins quota imap_quota imap_sieve
    mail_max_userip_connections = 20
    imap_idle_notify_interval = 29 mins
}

protocol lmtp {
    postmaster_address = postmaster@{{ mail_domains[0].name }}
    mail_plugins = $mail_plugins sieve
}

# Client authentication
disable_plaintext_auth = yes
auth_mechanisms = plain login

passdb {
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf
}

userdb {
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf
}

# Mail location
mail_uid = {{ mail_storage_user }}
mail_gid = {{ mail_storage_group }}
mail_privileged_group = {{ mail_storage_group }}

mail_home = {{ [mailboxes_dir, '%d', '%n'] | ansible.builtin.path_join }}
mail_location = maildir:~/mail:LAYOUT=fs

# Mailbox configuration
namespace inbox {
    inbox = yes

    mailbox Spam {
        auto = subscribe
        special_use = \Junk
    }

    mailbox Trash {
        auto = subscribe
        special_use = \Trash
    }

    mailbox Drafts {
        auto = subscribe
        special_use = \Drafts
    }

    mailbox Sent {
        auto = subscribe
        special_use = \Sent
    }
}

# Mail plugins
plugin {
    sieve_plugins = sieve_imapsieve sieve_extprograms
    sieve_before = {{ [sieve_global_dir, 'spam-global.sieve'] | ansible.builtin.path_join }}
    sieve = file:{{ [sieve_users_dir, 'scripts'] | ansible.builtin.path_join }};active={{ [sieve_users_dir, 'active-script.sieve'] | ansible.builtin.path_join }}

    ## Spam learning
    
    ### From elsewhere to Spam folder
    imapsieve_mailbox1_name = Spam
    imapsieve_mailbox1_causes = COPY
    imapsieve_mailbox1_before = file:{{ [sieve_global_dir, 'learn-spam.sieve'] | ansible.builtin.path_join }}

    ### From Spam folder to elsewhere
    imapsieve_mailbox2_name = *
    imapsieve_mailbox2_from = Spam
    imapsieve_mailbox2_causes = COPY
    imapsieve_mailbox2_before = file:{{ [sieve_global_dir, 'learn-ham.sieve'] | ansible.builtin.path_join }}

    sieve_pipe_bin_dir = {{ sieve_pipe_bin_dir }}
    sieve_global_extensions = +vnd.dovecot.pipe

    quota = maildir:User quota
    quota_exceeded_message = User %u has exhausted allowed storage space.

    ## Stats
    
    ### how often to session statistics (must be set)
    stats_refresh = 30 secs
    ### track per-IMAP command statistics (optional)
    stats_track_cmds = yes
}
